#!/bin/bash
set -e

# =============================================================================
# timestampctl - Script de control para bitácora timestamp por proyecto
# Versión: 1.0
# =============================================================================

# Detección automática de rutas
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$(dirname "$SCRIPT_DIR")")"
BITACORA_DIR="$PROJECT_DIR/.bitacora/timestamp"
PID_FILE="$BITACORA_DIR/bitacora_timestamp.pid"
TIMESTAMP_FILE="$BITACORA_DIR/timestamp.txt"
LOG_FILE="$BITACORA_DIR/bitacora_timestamp.log"

# Verificar si systemd está disponible
HAS_SYSTEMD=false
if command -v systemctl >/dev/null 2>&1 && systemctl --user status >/dev/null 2>&1; then
    HAS_SYSTEMD=true
    PROJECT_ESCAPED=$(systemd-escape "$PROJECT_DIR")
    SERVICE_NAME="bitacora_timestamp@${PROJECT_ESCAPED}"
fi

# Verificar si el binario está instalado
if ! command -v bitacora_timestamp >/dev/null 2>&1; then
    echo "Error: bitacora_timestamp no encontrado en PATH"
    echo "Instala el binario en ~/.local/bin/ y asegúrate de que esté en PATH"
    exit 1
fi

start_service() {
    echo "=== Iniciando Bitácora Timestamp ==="
    echo "Proyecto: $PROJECT_DIR"
    
    # Validar y crear directorio bitácora si no existe
    if [ ! -d "$BITACORA_DIR" ]; then
        echo "Creando directorio: $BITACORA_DIR"
        mkdir -p "$BITACORA_DIR"
    fi
    
    # Verificar si ya hay un proceso activo
    if [ -f "$PID_FILE" ]; then
        if kill -0 "$(cat "$PID_FILE")" 2>/dev/null; then
            echo "❌ Ya hay un proceso activo (PID: $(cat "$PID_FILE"))"
            echo "Use: $0 stop para detenerlo primero"
            exit 1
        else
            echo "Limpiando PID huérfano..."
            rm -f "$PID_FILE"
        fi
    fi
    
    # Forzar modo nohup por ahora (systemd tiene problemas con rutas largas)
    echo "Usando nohup (modo respaldo)..."
    
    # Crear archivo de log si no existe
    if [ ! -f "$LOG_FILE" ]; then
        touch "$LOG_FILE"
    fi
    
    nohup bitacora_timestamp timestamp_start "$PROJECT_DIR" > "$LOG_FILE" 2>&1 &
    sleep 1
    
    # Verificar que se inició correctamente
    if [ -f "$PID_FILE" ] && kill -0 "$(cat "$PID_FILE")" 2>/dev/null; then
        echo "✅ Proceso iniciado correctamente (PID: $(cat "$PID_FILE"))"
        echo "Logs: $LOG_FILE"
        echo "Archivo timestamp: $TIMESTAMP_FILE"
    else
        echo "❌ Error al iniciar el proceso"
        echo "Ver logs en: $LOG_FILE"
        exit 1
    fi
}

stop_service() {
    echo "=== Deteniendo Bitácora Timestamp ==="
    
    if [ -f "$PID_FILE" ]; then
        PID=$(cat "$PID_FILE")
        echo "Deteniendo proceso PID: $PID"
        
        if kill -0 "$PID" 2>/dev/null; then
            bitacora_timestamp timestamp_stop "$PROJECT_DIR"
            echo "✅ Proceso detenido correctamente"
        else
            echo "ℹ️  Proceso ya no estaba activo"
            rm -f "$PID_FILE"
        fi
    else
        echo "ℹ️  No hay archivo PID - el servicio no estaba activo"
    fi
}

restart_service() {
    echo "=== Reiniciando Bitácora Timestamp ==="
    stop_service
    sleep 2
    start_service
}

status_service() {
    echo "=== Estado Bitácora Timestamp ==="
    echo "Proyecto: $PROJECT_DIR"
    echo
    
    if [ "$HAS_SYSTEMD" = true ]; then
        echo "--- Estado systemd ---"
        if systemctl --user is-active --quiet "$SERVICE_NAME"; then
            echo "✅ Servicio activo"
            systemctl --user status "$SERVICE_NAME" --no-pager -l
        else
            echo "❌ Servicio inactivo"
        fi
    else
        echo "--- Estado nohup ---"
        if [ -f "$PID_FILE" ]; then
            PID=$(cat "$PID_FILE")
            if kill -0 "$PID" 2>/dev/null; then
                echo "✅ Proceso activo (PID: $PID)"
            else
                echo "❌ PID file existe pero proceso no está activo"
                echo "Ejecuta 'restart' para limpiar y reiniciar"
            fi
        else
            echo "❌ No hay proceso activo (sin PID file)"
        fi
    fi
    
    echo
    echo "--- Estado timestamp ---"
    if [ -f "$TIMESTAMP_FILE" ]; then
        LAST_TIMESTAMP=$(cat "$TIMESTAMP_FILE")
        echo "Último timestamp: $LAST_TIMESTAMP"
        echo "Archivo: $TIMESTAMP_FILE"
        
        if command -v date >/dev/null 2>&1; then
            CURRENT_TIME=$(date +%s)
            TIMESTAMP_TIME=$(date -d "${LAST_TIMESTAMP:0:4}-${LAST_TIMESTAMP:4:2}-${LAST_TIMESTAMP:6:2} ${LAST_TIMESTAMP:9:2}:${LAST_TIMESTAMP:11:2}" +%s 2>/dev/null || echo "0")
            if [ "$TIMESTAMP_TIME" != "0" ]; then
                AGE=$((CURRENT_TIME - TIMESTAMP_TIME))
                echo "Antigüedad: ${AGE}s (debe ser <120s si está funcionando)"
                if [ "$AGE" -gt 120 ]; then
                    echo "⚠️  Timestamp parece desactualizado"
                fi
            fi
        fi
    else
        echo "❌ Archivo timestamp no existe"
    fi
    
    if [ -f "$LOG_FILE" ]; then
        echo
        echo "--- Últimas líneas del log ---"
        tail -n 5 "$LOG_FILE"
    fi
}

case "${1:-}" in
    start) start_service ;;
    stop) stop_service ;;
    restart) restart_service ;;
    status) status_service ;;
    *)
        echo "Uso: $0 {start|stop|restart|status}"
        echo
        echo "Gestiona el servicio de timestamp para este proyecto:"
        echo "  start   - Iniciar servicio"
        echo "  stop    - Detener servicio"
        echo "  restart - Reiniciar servicio"
        echo "  status  - Ver estado actual y último timestamp"
        echo
        echo "Proyecto: $PROJECT_DIR"
        exit 1
        ;;
esac
